<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>Enquete</title>
    <div th:replace="~{fragments/commons :: head}"></div>
</head>
<body>
    <div th:insert="~{fragments/commons :: header}"></div>

    <div class="container">
        <div class="card" th:attr="data-poll-id=${poll.id}">
            <div class="card-header">
                <h2 class="card-title" th:text="${poll.question}"></h2>
                <div th:if="${poll.userId() == userId}">
                    <span><button type="button" class="delete-btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#staticBackdrop"><i class="fa-solid fa-trash"></i></button></span>
                    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h1 class="modal-title fs-5" id="staticBackdropLabel">Deletar enquete</h1>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    Tem certeza que deseja excluir esta enquete?
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não</button>
                                    <form  th:action="@{/poll/{id}/delete(id=${poll.id})}" method="post">
                                        <button type="submit" class="btn btn-primary">Sim</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <form th:if="${!poll.userAlreadyVoted() and !poll.isExpired}" th:action="@{/poll/{id}(id=${poll.id})}" method="post">
                <div class="card-content">
                    <div class="options">
                        <div th:each="option : ${poll.options}" class="option-details radio-option">
                            <label class="option-label" th:for="${'option_' + option.id}">
                                <div>
                                    <strong th:text="${option.text}" class=""></strong>
                                    <span>
                                        <small class="votes"
                                               th:text="|(${option.votes} ${option.votes == 1 ? 'voto' : 'votos'})|">
                                        </small>
                                    </span>
                                </div>
                                <div class="progress-container">
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-3">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated custom-color-bar"
                                                 role="progressbar"
                                                 th:aria-valuenow="${option.percentage}"
                                                 aria-valuemin="0"
                                                 aria-valuemax="100"
                                                 th:style="'width: ' + ${option.percentage} + '%;'">
                                                <span class="bar-text" th:text="${#numbers.formatDecimal(option.percentage, 1, 1)} + '%'"></span>
                                            </div>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio"
                                                   th:name="option"
                                                   th:value="${option.id}"
                                                   th:id="${'option_' + option.id}">
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="poll-stats">
                        <span>
                        <i class="fas fa-chart-bar"></i>
                            <span th:text="|${poll.totalVotes} ${poll.totalVotes == 1 ? ' voto' : ' votos'}|"></span>
                        </span>

                        <span th:if="${poll.expired}" class="badge bg-timer-closed bg-warning">Finalizada</span>
                        <span th:unless="${poll.expired}"
                              class="badge bg-success bg-timer poll-timer"
                              th:data-expires-at="${poll.expiresAt.toEpochMilli()}">
                            <span th:text="${poll.timeLeft}"></span>
                        </span>
                    </div>
                </div>

                <div class="card-footer" style="margin-top: 10px;">
                    <div class="footer-stats">
                    <span>
                        <i class="far fa-user"></i>
                        <span th:text="${poll.createdBy}"></span>
                    </span>
                        <span><i class="far fa-calendar"></i>
                        <span th:text="${#temporals.format(poll.createdAt, 'dd/MM/yyyy')}"></span>
                    </span>
                    </div>

                    <div class="poll-btn">
                        <button type="button" id="btn-share" class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#staticBackdropFooter">Compartilhar<i class="fa-solid fa-share-from-square ms-2"></i></button>
                        <button th:if="${!poll.userAlreadyVoted()}" type="submit" id="btn-vote" class="btn btn-primary mt-2 float-end">Confirmar</button>
                    </div>
                </div>
            </form>

            <div th:if="${poll.userAlreadyVoted() and !poll.isExpired}">
                <div class="card-content">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-check-circle me-2"></i>Você já votou nesta enquete!
                    </div>
                    <div class="options">
                        <div th:each="option : ${poll.options()}"
                             th:classappend="${option.id() == poll.userVoteOptionId()} ? 'user-vote-selected' : ''"
                             class="option-details">
                            <label class="option-label" th:for="${'option_' + option.id()}">
                                <div>
                                    <strong th:text="${option.text()}" class=""></strong>
                                    <span th:if="${option.id() == poll.userVoteOptionId()}"
                                          class="badge bg-success ms-2">
                                            <i class="fas fa-check me-1"></i>Seu voto
                                    </span>
                                    <span>
                                        <small class="votes"
                                               th:text="|(${option.votes} ${option.votes == 1 ? 'voto' : 'votos'})|">
                                        </small>
                                    </span>
                                </div>
                                <div class="progress-container">
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-3">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated custom-color-bar"
                                                 role="progressbar"
                                                 th:aria-valuenow="${option.percentage()}"
                                                 aria-valuemin="0"
                                                 aria-valuemax="100"
                                                 th:style="'width: ' + ${option.percentage()} + '%;'">
                                                <span class="bar-text" th:text="${#numbers.formatDecimal(option.percentage(), 1, 1)} + '%'"></span>
                                            </div>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio"
                                                   th:name="option"
                                                   th:value="${option.id()}"
                                                   th:id="${'option_' + option.id()}"
                                                   th:checked="${option.id() == poll.userVoteOptionId()}"
                                                   disabled>
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="poll-stats">
                        <span>
                            <i class="fas fa-chart-bar"></i>
                            <span th:text="|${poll.totalVotes} ${poll.totalVotes == 1 ? ' voto' : ' votos'}|"></span>
                        </span>

                        <span th:if="${poll.expired}" class="badge bg-timer-closed bg-warning">Finalizada</span>
                        <span th:unless="${poll.expired}"
                              class="badge bg-success bg-timer poll-timer"
                              th:data-expires-at="${poll.expiresAt.toEpochMilli()}">
                            <span th:text="${poll.timeLeft}"></span>
                        </span>
                    </div>
                </div>

                <div class="card-footer" style="margin-top: 10px;">
                    <div class="footer-stats">
                        <span>
                            <i class="far fa-user"></i>
                            <span th:text="${poll.createdBy}"></span>
                        </span>
                            <span><i class="far fa-calendar"></i>
                            <span th:text="${#temporals.format(poll.createdAt, 'dd/MM/yyyy')}"></span>
                        </span>
                    </div>

                    <div class="poll-btn">
                        <button type="button" id="btn-share" class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#staticBackdropFooter">Compartilhar<i class="fa-solid fa-share-from-square ms-2"></i></button>
                    </div>
                </div>
            </div>

            <div th:if="${poll.isExpired}">
                <div class="card-content">
                    <div th:if="${poll.userAlreadyVoted()}" class="alert alert-info mb-3">
                        <i class="fas fa-check-circle me-2"></i>Você já votou nesta enquete!
                    </div>
                    <div class="options">
                        <div th:each="option : ${poll.options()}"
                             th:class="'option-details ' +
                              (${option.id() == poll.userVoteOptionId()} ? 'user-vote-selected' : '') +
                              ' ' +
                              (${#lists.contains(poll.winnerOptionIds, option.id)} ? 'winner-option' : '')"
                             class="option-details">
                            <label class="option-label" th:for="${'option_' + option.id()}">
                                <div>
                                    <strong th:text="${option.text()}" class=""></strong>
                                    <span th:if="${option.id() == poll.userVoteOptionId()}"
                                          class="badge bg-success ms-2">
                                            <i class="fas fa-check me-1"></i>Seu voto
                                    </span>
                                    <span>
                                        <small class="votes"
                                               th:text="|(${option.votes} ${option.votes == 1 ? 'voto' : 'votos'})|">
                                        </small>
                                    </span>
                                </div>
                                <div class="progress-container">
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-3">
                                            <div class="progress-bar custom-color-bar"
                                                 role="progressbar"
                                                 th:aria-valuenow="${option.percentage()}"
                                                 aria-valuemin="0"
                                                 aria-valuemax="100"
                                                 th:style="'width: ' + ${option.percentage()} + '%;'">
                                                <span class="bar-text" th:text="${#numbers.formatDecimal(option.percentage(), 1, 1)} + '%'"></span>
                                            </div>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio"
                                                   th:name="option"
                                                   th:value="${option.id()}"
                                                   th:id="${'option_' + option.id()}"
                                                   th:checked="${option.id() == poll.userVoteOptionId()}"
                                                   disabled>
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div class="poll-stats">
                        <span>
                            <i class="fas fa-chart-bar"></i>
                            <span th:text="|${poll.totalVotes} ${poll.totalVotes == 1 ? ' voto' : ' votos'}|"></span>
                        </span>
                        <span class="badge bg-timer-closed bg-warning">Finalizada</span>
                    </div>

                    <div class="card-footer" style="margin-top: 10px;">
                        <div class="footer-stats">
                            <span>
                                <i class="far fa-user"></i>
                                <span th:text="${poll.createdBy}"></span>
                            </span>
                                <span><i class="far fa-calendar"></i>
                                <span th:text="${#temporals.format(poll.createdAt, 'dd/MM/yyyy')}"></span>
                            </span>
                        </div>

                        <div class="poll-btn">
                            <button type="button" id="btn-share" class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#staticBackdropFooter">Compartilhar<i class="fa-solid fa-share-from-square ms-2"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="staticBackdropFooter" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabelFooter" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h1 class="modal-title fs-5" id="staticBackdropLabelFooter">Compartilhar</h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="recipient-name" class="col-form-label"></label>
                                <div class="d-flex gap-2 align-items-center">
                                    <input type="text" class="form-control" id="recipient-name" readonly>
                                    <button type="button" class="copy-btn" id="copyLinkBtn"><i class="fa-solid fa-copy"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <div class="toast align-items-center text-white bg-success fade hide" id="copyToast">
            <div class="d-flex">
                <div class="toast-body">
                    Link copiado com sucesso!
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/timer-script :: timer-script}"></div>

    <script>
        const currentUrl = window.location.href;

        document.getElementById('staticBackdropFooter').addEventListener('show.bs.modal', function () {
            document.getElementById('recipient-name').value = currentUrl;
        });

        document.getElementById('copyLinkBtn').addEventListener('click', function() {
        navigator.clipboard.writeText(currentUrl).then(function() {
            const toast = new bootstrap.Toast(document.getElementById('copyToast'));
            toast.show();
        }).catch(function(err) {
        console.error('Erro ao copiar: ', err);
        alert('Erro ao copiar o link');
        });
    });
    </script>

    <div th:insert="~{fragments/commons :: scripts}"></div>
</body>

<footer>
    <div class="container">
    </div>
</footer>
</html>